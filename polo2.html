<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>整式运算小游戏</title>
<style>
  body{font-family:system-ui, "Helvetica Neue", Arial; background:linear-gradient(135deg,#f8fafc,#e6f0ff); margin:0; padding:20px; color:#0b2545}
  .container{max-width:900px;margin:20px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 6px 30px rgba(11,37,69,0.08)}
  h1{margin:0 0 10px;font-size:1.6rem}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  select,input[type=number]{padding:8px;border-radius:6px;border:1px solid #d0d7e6}
  button{background:#1e88e5;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#e7eefc;color:#1e3a5f}
  .panel{display:flex;gap:16px;align-items:center;margin:16px 0}
  .polynomial{font-family: "Times New Roman", Times, serif; font-size:1.4rem; background:#f1f6ff;padding:12px;border-radius:8px}
  .input-area{display:flex;gap:8px;align-items:center}
  input.answer{padding:8px;border-radius:6px;border:1px solid #cfd8e9;min-width:260px}
  .status{margin-top:12px}
  .hint{background:#fff3cd;border:1px solid #ffe8a6;padding:8px;border-radius:6px}
  .scoreboard{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .scorebox{padding:8px 10px;border-radius:6px;background:#f7fbff;border:1px solid #e1edff}
  .footer{font-size:0.85rem;color:#65758a;margin-top:16px}
  .small{font-size:0.85rem;color:#44576b}
  .correct{color:green;font-weight:600}
  .wrong{color:#c62828;font-weight:600}
  .center{display:flex;align-items:center;gap:12px}
</style>
</head>
<body>
  <div class="container">
    <h1>整式运算小游戏 — 多项式加、减、乘</h1>
    <div class="controls">
      <label>运算：
        <select id="operation">
          <option value="add">加法</option>
          <option value="sub">减法</option>
          <option value="mul">乘法</option>
        </select>
      </label>
      <label>难度（最高次数）：
        <select id="degree">
          <option value="1">1（一次）</option>
          <option value="2" selected>2（二次）</option>
          <option value="3">3（3次）</option>
          <option value="4">4（4次）</option>
        </select>
      </label>
      <label>题数：
        <input id="numQuestions" type="number" value="10" min="1" max="100" />
      </label>
      <label>计时（秒，每题）：
        <input id="timePerQ" type="number" value="30" min="5" />
      </label>
      <button id="startBtn">开始游戏</button>
      <button id="nextBtn" class="secondary" style="display:none">下一题</button>
      <button id="showAnswerBtn" class="secondary" style="display:none">显示正确答案</button>
    </div>
    <div class="panel">
      <div>
        <div class="small">第 <span id="currentIdx">0</span> / <span id="totalQ">0</span> 题</div>
        <div style="margin-top:8px" class="polynomial" id="polyDisplay">点击“开始游戏”开始</div>
        <div class="small" style="margin-top:6px">提示：输入格式样例如 <code>3x^2-2x+1</code> 或 <code>-x^2+4x-5</code> （不需要空格）</div>
      </div>
      <div style="flex:1">
        <div class="input-area">
          <input id="answerInput" class="answer" placeholder="在这里输入你的结果，例如：2x^2+x-3" />
          <button id="submitBtn">提交</button>
          <button id="hintBtn" class="secondary">提示</button>
        </div>
        <div class="status" id="status"></div>
        <div class="hint" id="hintBox" style="display:none;margin-top:8px"></div>
      </div>
    </div>
    <div class="scoreboard">
      <div class="scorebox">得分：<span id="score">0</span></div>
      <div class="scorebox">正确：<span id="correctCount">0</span></div>
      <div class="scorebox">错误：<span id="wrongCount">0</span></div>
      <div class="scorebox">时间剩余：<span id="timer">0</span>s</div>
    </div>
    <div class="footer">
      <div>说明：每题给出两个随机多项式，用户按选择的运算（加/减/乘）计算结果并输入。系统会解析并化简你的答案来比对正确性。支持系数为整数、含隐式1或-1的项、以及常数项。</div>
    </div>
  </div>
<script>
/* ---------- 多项式生成/解析/运算工具 ---------- */
function formatPoly(coeffs) {
  let n = coeffs.length - 1;
  while (n > 0 && Math.abs(coeffs[n]) < 1e-9) n--;
  let parts = [];
  for (let i = n; i >= 0; i--) {
    let c = coeffs[i];
    if (Math.abs(c) < 1e-9) continue;
    let sign = c >= 0 ? "+" : "-";
    let absC = Math.abs(c);
    let coefStr = "";
    if (i === 0) {
      coefStr = String(absC);
    } else if (Math.abs(absC - 1) < 1e-9) {
      coefStr = "";
    } else {
      coefStr = String(absC);
    }
    let varPart = i === 0 ? "" : (i === 1 ? "x" : "x^" + i);
    parts.push((sign === "+" && parts.length === 0 ? "" : sign) + coefStr + varPart);
  }
  if (parts.length === 0) return "0";
  let s = parts.join("");
  if (s[0] === "+") s = s.slice(1);
  return s;
}
function parsePoly(str) {
  str = str.replace(/\s+/g, "");
  if (str.length === 0) throw new Error("输入为空");
  str = str.replace(/^\+/, "");
  let parts = [];
  let i = 0;
  while (i < str.length) {
    let sign = "+";
    if (str[i] === "+" || str[i] === "-") { sign = str[i]; i++; }
    let j = i;
    while (j < str.length && str[j] !== "+" && str[j] !== "-") j++;
    let token = sign + str.slice(i, j);
    parts.push(token);
    i = j;
  }
  let coeffs = [];
  for (let token of parts) {
    if (token === "+" || token === "-") continue;
    let mVar = token.match(/^([+-]?)(\d*)(x)(?:\^(\d+))?$/i);
    if (mVar) {
      let sgn = mVar[1] === "-" ? -1 : 1;
      let num = mVar[2];
      let pow = mVar[4] ? parseInt(mVar[4], 10) : 1;
      let coef = (num === "" ? 1 : parseInt(num,10)) * sgn;
      coeffs[pow] = (coeffs[pow] || 0) + coef;
      continue;
    }
    let mConst = token.match(/^([+-]?\d+)$/);
    if (mConst) {
      let v = parseInt(mConst[1],10);
      coeffs[0] = (coeffs[0] || 0) + v;
      continue;
    }
    throw new Error("无法解析项：" + token);
  }
  let maxDeg = coeffs.length - 1;
  if (maxDeg < 0) return [0];
  for (let k = 0; k <= maxDeg; k++) if (typeof coeffs[k] === "undefined") coeffs[k] = 0;
  return coeffs;
}
function addPoly(a, b) {
  let n = Math.max(a.length, b.length);
  let res = new Array(n).fill(0);
  for (let i=0;i<n;i++){
    res[i] = (a[i]||0) + (b[i]||0);
  }
  return res;
}
function subPoly(a, b) {
  let n = Math.max(a.length, b.length);
  let res = new Array(n).fill(0);
  for (let i=0;i<n;i++){
    res[i] = (a[i]||0) - (b[i]||0);
  }
  return res;
}
function mulPoly(a, b) {
  let na = a.length, nb = b.length;
  let res = new Array(na+nb-1).fill(0);
  for (let i=0;i<na;i++){
    for (let j=0;j<nb;j++){
      res[i+j] += (a[i]||0)*(b[j]||0);
    }
  }
  return res;
}
function normalize(coeffs) {
  let n = coeffs.length-1;
  while (n>0 && Math.abs(coeffs[n])<1e-9) n--;
  return coeffs.slice(0, n+1);
}
function equalPoly(a,b) {
  a = normalize(a); b = normalize(b);
  let n = Math.max(a.length, b.length);
  for (let i=0;i<n;i++){
    if (Math.abs((a[i]||0) - (b[i]||0)) > 1e-9) return false;
  }
  return true;
}
function randomPoly(maxDeg, coefRange=5, allowZeroLeading=false) {
  let deg = Math.floor(Math.random()*(maxDeg+1));
  let coeffs = new Array(deg+1).fill(0);
  for (let i=0;i<=deg;i++){
    if (Math.random() < 0.7) {
      let v = Math.floor(Math.random()*(2*coefRange+1)) - coefRange;
      if (i===deg && !allowZeroLeading) {
        while (v === 0) v = Math.floor(Math.random()*(2*coefRange+1)) - coefRange;
      }
      coeffs[i] = v;
    } else coeffs[i] = 0;
  }
  let allZero = coeffs.every(c=>c===0);
  if (allZero) return [0];
  return normalize(coeffs);
}
function makeQuestion(op, maxDeg) {
  let A = randomPoly(maxDeg, 6);
  let B = randomPoly(maxDeg, 6);
  if (op === 'mul') {
    A = randomPoly(Math.max(1, Math.min(maxDeg, 2)), 4);
    B = randomPoly(Math.max(1, Math.min(maxDeg, 2)), 4);
  }
  let ans;
  if (op === 'add') ans = addPoly(A,B);
  else if (op === 'sub') ans = subPoly(A,B);
  else ans = mulPoly(A,B);
  let opSymbol = op === 'ad...