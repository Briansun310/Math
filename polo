<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>整式运算小游戏</title>
<style>
  body{font-family:system-ui, "Helvetica Neue", Arial; background:linear-gradient(135deg,#f8fafc,#e6f0ff); margin:0; padding:20px; color:#0b2545}
  .container{max-width:900px;margin:20px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 6px 30px rgba(11,37,69,0.08)}
  h1{margin:0 0 10px;font-size:1.6rem}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  select,input[type=number]{padding:8px;border-radius:6px;border:1px solid #d0d7e6}
  button{background:#1e88e5;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#e7eefc;color:#1e3a5f}
  .panel{display:flex;gap:16px;align-items:center;margin:16px 0}
  .polynomial{font-family: "Times New Roman", Times, serif; font-size:1.4rem; background:#f1f6ff;padding:12px;border-radius:8px}
  .input-area{display:flex;gap:8px;align-items:center}
  input.answer{padding:8px;border-radius:6px;border:1px solid #cfd8e9;min-width:260px}
  .status{margin-top:12px}
  .hint{background:#fff3cd;border:1px solid #ffe8a6;padding:8px;border-radius:6px}
  .scoreboard{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .scorebox{padding:8px 10px;border-radius:6px;background:#f7fbff;border:1px solid #e1edff}
  .footer{font-size:0.85rem;color:#65758a;margin-top:16px}
  .small{font-size:0.85rem;color:#44576b}
  .correct{color:green;font-weight:600}
  .wrong{color:#c62828;font-weight:600}
  .center{display:flex;align-items:center;gap:12px}
</style>
</head>
<body>
  <div class="container">
    <h1>整式运算小游戏 — 多项式加、减、乘</h1>
    <div class="controls">
      <label>运算：
        <select id="operation">
          <option value="add">加法</option>
          <option value="sub">减法</option>
          <option value="mul">乘法</option>
        </select>
      </label>

      <label>难度（最高次数）：
        <select id="degree">
          <option value="1">1（一次）</option>
          <option value="2" selected>2（二次）</option>
          <option value="3">3（3次）</option>
          <option value="4">4（4次）</option>
        </select>
      </label>

      <label>题数：
        <input id="numQuestions" type="number" value="10" min="1" max="100" />
      </label>

      <label>计时（秒，每题）：
        <input id="timePerQ" type="number" value="30" min="5" />
      </label>

      <button id="startBtn">开始游戏</button>
      <button id="nextBtn" class="secondary" style="display:none">下一题</button>
      <button id="showAnswerBtn" class="secondary" style="display:none">显示正确答案</button>
    </div>

    <div class="panel">
      <div>
        <div class="small">第 <span id="currentIdx">0</span> / <span id="totalQ">0</span> 题</div>
        <div style="margin-top:8px" class="polynomial" id="polyDisplay">点击“开始游戏”开始</div>
        <div class="small" style="margin-top:6px">提示：输入格式样例如 <code>3x^2-2x+1</code> 或 <code>-x^2+4x-5</code> （不需要空格）</div>
      </div>

      <div style="flex:1">
        <div class="input-area">
          <input id="answerInput" class="answer" placeholder="在这里输入你的结果，例如：2x^2+x-3" />
          <button id="submitBtn">提交</button>
          <button id="hintBtn" class="secondary">提示</button>
        </div>
        <div class="status" id="status"></div>
        <div class="hint" id="hintBox" style="display:none;margin-top:8px"></div>
      </div>
    </div>

    <div class="scoreboard">
      <div class="scorebox">得分：<span id="score">0</span></div>
      <div class="scorebox">正确：<span id="correctCount">0</span></div>
      <div class="scorebox">错误：<span id="wrongCount">0</span></div>
      <div class="scorebox">时间剩余：<span id="timer">0</span>s</div>
    </div>

    <div class="footer">
      <div>说明：每题给出两个随机多项式，用户按选择的运算（加/减/乘）计算结果并输入。系统会解析并化简你的答案来比对正确性。支持系数为整数、含隐式1或-1的项、以及常数项。</div>
    </div>
  </div>

<script>
/* ---------- 多项式生成/解析/运算工具 ---------- */

/* 将系数数组（coeffs[i] 表示 x^i 的系数）格式化为字符串（降幂） */
function formatPoly(coeffs) {
  // 去掉末尾为0的高次项
  let n = coeffs.length - 1;
  while (n > 0 && Math.abs(coeffs[n]) < 1e-9) n--;
  let parts = [];
  for (let i = n; i >= 0; i--) {
    let c = coeffs[i];
    if (Math.abs(c) < 1e-9) continue;
    let sign = c >= 0 ? "+" : "-";
    let absC = Math.abs(c);
    let coefStr = "";
    if (i === 0) {
      coefStr = String(absC);
    } else if (Math.abs(absC - 1) < 1e-9) {
      coefStr = ""; // 省略系数1
    } else {
      coefStr = String(absC);
    }
    let varPart = i === 0 ? "" : (i === 1 ? "x" : "x^" + i);
    parts.push((sign === "+" && parts.length === 0 ? "" : sign) + coefStr + varPart);
  }
  if (parts.length === 0) return "0";
  let s = parts.join("");
  // 如果以+开头去掉+
  if (s[0] === "+") s = s.slice(1);
  return s;
}

/* 解析用户输入的多项式字符串，返回系数数组 */
function parsePoly(str) {
  str = str.replace(/\s+/g, "");
  if (str.length === 0) throw new Error("输入为空");
  // 规范化：把所有 - 替换为 +-
  // 但要处理起始的负号已被保留
  str = str.replace(/^\+/, "");
  // 在每个 + 和 - 前插入分隔符，但保留首位符号
  let parts = [];
  let i = 0;
  while (i < str.length) {
    let sign = "+";
    if (str[i] === "+" || str[i] === "-") { sign = str[i]; i++; }
    let j = i;
    while (j < str.length && str[j] !== "+" && str[j] !== "-") j++;
    let token = sign + str.slice(i, j);
    parts.push(token);
    i = j;
  }
  // 处理每个 token
  let coeffs = [];
  for (let token of parts) {
    if (token === "+" || token === "-") continue;
    // token 示例: "+3x^2", "-x", "+5"
    let mVar = token.match(/^([+-]?)(\d*)(x)(?:\^(\d+))?$/i);
    if (mVar) {
      let sgn = mVar[1] === "-" ? -1 : 1;
      let num = mVar[2];
      let pow = mVar[4] ? parseInt(mVar[4], 10) : 1;
      let coef = (num === "" ? 1 : parseInt(num,10)) * sgn;
      coeffs[pow] = (coeffs[pow] || 0) + coef;
      continue;
    }
    // 常数项
    let mConst = token.match(/^([+-]?\d+)$/);
    if (mConst) {
      let v = parseInt(mConst[1],10);
      coeffs[0] = (coeffs[0] || 0) + v;
      continue;
    }
    throw new Error("无法解析项：" + token);
  }
  // 转为完整数组（填充间隙为0）
  let maxDeg = coeffs.length - 1;
  if (maxDeg < 0) return [0];
  for (let k = 0; k <= maxDeg; k++) if (typeof coeffs[k] === "undefined") coeffs[k] = 0;
  return coeffs;
}

/* 多项式加法（系数数组）*/
function addPoly(a, b) {
  let n = Math.max(a.length, b.length);
  let res = new Array(n).fill(0);
  for (let i=0;i<n;i++){
    res[i] = (a[i]||0) + (b[i]||0);
  }
  return res;
}

/* 多项式减法 a - b */
function subPoly(a, b) {
  let n = Math.max(a.length, b.length);
  let res = new Array(n).fill(0);
  for (let i=0;i<n;i++){
    res[i] = (a[i]||0) - (b[i]||0);
  }
  return res;
}

/* 多项式乘法（卷积）*/
function mulPoly(a, b) {
  let na = a.length, nb = b.length;
  let res = new Array(na+nb-1).fill(0);
  for (let i=0;i<na;i++){
    for (let j=0;j<nb;j++){
      res[i+j] += (a[i]||0)*(b[j]||0);
    }
  }
  return res;
}

/* 将解析到的系数数组标准化（去掉末尾0） */
function normalize(coeffs) {
  let n = coeffs.length-1;
  while (n>0 && Math.abs(coeffs[n])<1e-9) n--;
  return coeffs.slice(0, n+1);
}

/* 比较两个系数数组（相等）*/
function equalPoly(a,b) {
  a = normalize(a); b = normalize(b);
  let n = Math.max(a.length, b.length);
  for (let i=0;i<n;i++){
    if (Math.abs((a[i]||0) - (b[i]||0)) > 1e-9) return false;
  }
  return true;
}

/* 生成随机多项式（系数为整数） */
function randomPoly(maxDeg, coefRange=5, allowZeroLeading=false) {
  // coefRange: 负到正的取值范围（不含0约束）
  let deg = Math.floor(Math.random()*(maxDeg+1));
  let coeffs = new Array(deg+1).fill(0);
  // 确保最高次项不为0（除非允许）
  for (let i=0;i<=deg;i++){
    // 70% 概率非零项（避免太稀疏）
    if (Math.random() < 0.7) {
      // 整数系数范围 [-coefRange, coefRange]
      let v = Math.floor(Math.random()*(2*coefRange+1)) - coefRange;
      // 避零
      if (i===deg && !allowZeroLeading) {
        while (v === 0) v = Math.floor(Math.random()*(2*coefRange+1)) - coefRange;
      }
      coeffs[i] = v;
    } else coeffs[i] = 0;
  }
  // 若全为0，返回常数0
  let allZero = coeffs.every(c=>c===0);
  if (allZero) return [0];
  return normalize(coeffs);
}

/* 生成一题：返回 {Acoeffs,Bcoeffs,op,questionStr,answerCoeffs,stepsHint} */
function makeQuestion(op, maxDeg) {
  let A = randomPoly(maxDeg, 6);
  let B = randomPoly(maxDeg, 6);
  // 为了降低乘法复杂度，若op=mul则限制较小系数
  if (op === 'mul') {
    // 适当减少次数或系数范围
    A = randomPoly(Math.max(1, Math.min(maxDeg, 2)), 4);
    B = randomPoly(Math.max(1, Math.min(maxDeg, 2)), 4);
  }
  let ans;
  if (op === 'add') ans = addPoly(A,B);
  else if (op === 'sub') ans = subPoly(A,B);
  else ans = mulPoly(A,B);
  // 生成用于显示的题目文本（两个多项式与运算符）
  let opSymbol = op === 'add' ? '+' : (op === 'sub' ? '-' : '×');
  let qStr = formatPoly(A) + "  " + opSymbol + "  " + formatPoly(B);
  let hint = generateHint(A, B, op);
  return {Acoeffs:A, Bcoeffs:B, op, questionStr:qStr, answerCoeffs: normalize(ans), stepsHint: hint};
}

/* 生成简易步骤提示（仅做示范，不展开完整手动推导）*/
function generateHint(A,B,op) {
  if (op === 'add' || op === 'sub') {
    return "按同类项相加/相减：把各次幂（x^0, x^1, x^2...）的系数相加或相减，然后写成标准降幂形式。";
  } else {
    return "乘法采用分配律（卷积）：每一项相乘并把相同次数的项合并（x^i * x^j = x^(i+j)）。";
  }
}

/* ---------- 游戏控制逻辑 ---------- */

let state = {
  questions: [],
  idx: 0,
  total: 0,
  score: 0,
  correct: 0,
  wrong: 0,
  timer: null,
  timeLeft: 0,
  timePerQ: 30,
  running: false
};

const el = id => document.getElementById(id);

function startGame() {
  // 读取设置
  const op = el('operation').value;
  const degree = parseInt(el('degree').value,10);
  const nQ = Math.max(1, Math.min(200, parseInt(el('numQuestions').value,10)||10));
  const tpq = Math.max(5, parseInt(el('timePerQ').value,10)||30);
  // 构建题目列表
  let qs = [];
  for (let i=0;i<nQ;i++) qs.push(makeQuestion(op, degree));
  state.questions = qs;
  state.idx = 0;
  state.total = nQ;
  state.score = 0;
  state.correct = 0;
  state.wrong = 0;
  state.timePerQ = tpq;
  state.running = true;
  el('totalQ').textContent = state.total;
  el('score').textContent = state.score;
  el('correctCount').textContent = 0;
  el('wrongCount').textContent = 0;
  el('startBtn').style.display = 'none';
  el('nextBtn').style.display = 'none';
  el('showAnswerBtn').style.display = 'none';
  el('status').textContent = '';
  el('hintBox').style.display = 'none';
  el('answerInput').value = '';
  showQuestion();
}

function endGame() {
  state.running = false;
  clearInterval(state.timer);
  el('status').innerHTML = `<div class="small">游戏结束！得分 <strong>${state.score}</strong>，正确 ${state.correct}，错误 ${state.wrong}</div>`;
  el('startBtn').style.display = '';
  el('nextBtn').style.display = 'none';
  el('showAnswerBtn').style.display = 'none';
  el('polyDisplay').textContent = "点击“开始游戏”重新开始";
  el('timer').textContent = '0';
}

function showQuestion() {
  if (state.idx >= state.total) {
    endGame();
    return;
  }
  const q = state.questions[state.idx];
  el('currentIdx').textContent = state.idx+1;
  el('polyDisplay').textContent = q.questionStr;
  el('answerInput').value = '';
  el('status').textContent = '';
  el('hintBox').style.display = 'none';
  el('showAnswerBtn').style.display = 'inline-block';
  el('nextBtn').style.display = 'none';
  // 设置计时器
  state.timeLeft = state.timePerQ;
  el('timer').textContent = state.timeLeft;
  clearInterval(state.timer);
  state.timer = setInterval(()=>{
    state.timeLeft--;
    el('timer').textContent = state.timeLeft;
    if (state.timeLeft <= 0) {
      clearInterval(state.timer);
      handleTimeout();
    }
  }, 1000);
}

function handleTimeout() {
  state.wrong++;
  el('wrongCount').textContent = state.wrong;
  el('status').innerHTML = `<div class="wrong">时间到！正确答案：<span class="small">${formatPoly(state.questions[state.idx].answerCoeffs)}</span></div>`;
  el('nextBtn').style.display = '';
  el('showAnswerBtn').style.display = 'none';
  state.idx++;
}

function submitAnswer() {
  if (!state.running) return;
  clearInterval(state.timer);
  let userStr = el('answerInput').value.trim();
  if (userStr.length === 0) {
    el('status').innerHTML = `<div class="wrong">请输入答案或点击“显示正确答案”。</div>`;
    // 重启计时器
    state.timer = setInterval(()=>{ state.timeLeft--; el('timer').textContent = state.timeLeft; if (state.timeLeft<=0){ clearInterval(state.timer); handleTimeout(); }},1000);
    return;
  }
  let userCoeffs;
  try {
    userCoeffs = parsePoly(userStr);
  } catch (e) {
    el('status').innerHTML = `<div class="wrong">解析失败：${e.message}</div>`;
    // 允许用户重试（重新开始计时）
    state.timer = setInterval(()=>{ state.timeLeft--; el('timer').textContent = state.timeLeft; if (state.timeLeft<=0){ clearInterval(state.timer); handleTimeout(); }},1000);
    return;
  }
  let correct = state.questions[state.idx].answerCoeffs;
  if (equalPoly(userCoeffs, correct)) {
    state.correct++;
    state.score += Math.max(1, Math.floor(state.timeLeft/3)+1); // 计分策略：剩余时间越多分数越高
    el('status').innerHTML = `<div class="correct">回答正确！标准答案：<span class="small">${formatPoly(correct)}</span></div>`;
    el('score').textContent = state.score;
    el('correctCount').textContent = state.correct;
  } else {
    state.wrong++;
    el('status').innerHTML = `<div class="wrong">回答错误。正确答案：<span class="small">${formatPoly(correct)}</span></div>`;
    el('wrongCount').textContent = state.wrong;
  }
  el('nextBtn').style.display = '';
  el('showAnswerBtn').style.display = 'none';
  state.idx++;
}

function showHint() {
  if (!state.running) return;
  let q = state.questions[state.idx];
  el('hintBox').textContent = q.stepsHint;
  el('hintBox').style.display = 'block';
}

function showAnswer() {
  if (!state.running) return;
  let ans = state.questions[state.idx].answerCoeffs;
  el('status').innerHTML = `<div class="small">正确答案：<strong>${formatPoly(ans)}</strong></div>`;
  clearInterval(state.timer);
  el('nextBtn').style.display = '';
  el('showAnswerBtn').style.display = 'none';
  state.wrong++;
  el('wrongCount').textContent = state.wrong;
  state.idx++;
}

/* 事件绑定 */
el('startBtn').addEventListener('click', startGame);
el('nextBtn').addEventListener('click', ()=>{ if (state.idx >= state.total) endGame(); else showQuestion(); });
el('submitBtn').addEventListener('click', submitAnswer);
el('hintBtn').addEventListener('click', showHint);
el('showAnswerBtn').addEventListener('click', showAnswer);
el('answerInput').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') submitAnswer(); });

/* 小提示：如果你需要扩展（比如支持除法、逐步评分、或用LaTeX渲染），我可以继续帮你 */
</script>
</body>
</html>
